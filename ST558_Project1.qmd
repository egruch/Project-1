---
title: "ST558 Project 1"
format: html
editor: visual
---

# Load Libraries

```{r}
# Load in the tidyverse libraries
library(tidyverse)
library(lubridate)
```

# Introduction

Introduction about what we are doing, discussion of what you are about to do and why/how, etc.

## Data

Maybe write anything about the API and data itself.

# Data Processing

## Helper Function

Getting the usual process to work with a given URL

Next, write a helper function to take what is returned by GET() and turn it into a nice tibble.

```{r}
APIurl <- "https://api.census.gov/data/2022/acs/acs1/pums?get=SEX,PWGTP,MAR&SCHL=24&for=state:09&key=51fa8d7040e7bff1dae932352f6b998a4678a557"

# Helper function to take what is returned by GET() and turn it into a tibble
api_tibble <- function(GET_output) {
  census_parsed <- jsonlite::fromJSON(rawToChar(GET_output$content))
  
  colnames(census_parsed) <- census_parsed[1,]
  census_parsed <- census_parsed[-1,]
  census_tibble <- as_tibble(census_parsed)
  class(census_tibble) <- c("census", class(census_tibble))
  return(census_tibble)
}

api_tibble(httr::GET(APIurl))

# This gives character type data for all columns, may need to change.
```

## Single Year Function

Write a function to query the API that allows the user to change the following items: (see project outline).

if else logic test

```{r}
year = 2022
num_var <- "PWGTP,MAR"
num_var2 <- c("PWGTP", "AGEP")
char_var = "SEX"
geo_level = "all"
geo_subset <- "09"
if (!is.numeric(year) | year < 2010 | year > 2022) {
  "BAD1" 
} else if (!is.element("PWGTP", num_var2)) {
    "BAD2"
} else if (length(num_var2) < 2) {
  "BAD3"
} else if ( !all(num_var2 %in% c("PWGTP", "AGEP", "GASP", "GRPIP", "JWAP", 
                             "JWDP", "JWMNP"))) {
  "BAD4"
} else if (!all(char_var %in% c("FER", "HHL", "HISPEED", "JWTRNS", "SCH", 
                             "SCHL", "SEX"))) {
  "BAD5"
  
  #char_var != "FER" & char_var != "HHL" & char_var != "HISPEED" &
             #char_var != "JWTRNS" & char_var != "SCH" & char_var != "SCHL" &
             #char_var != "SEX") {
    #"BAD3"
} else if (geo_level != "state" & geo_level != "division" & 
           geo_level != "region" & char_var != "all"){
  "BAD6"  
  } else {
  "yay"
}

geo_paste <- ifelse(geo_level == "all", "",
                        paste0("&for=",geo_level,":",
                        geo_subset))



```

Dictionary

```{r}
FER_dict <- c("0" = "N/A (less than 15 years/greater than 50 years/ male)",
              "1" = "Yes",
              "2" = "No")

HHL_dict <- c("0" = "N/A (GQ/vacant)",
              "1" = "English Only",
              "2" = "Spanish",
              "3" = "Other Indo-European languages",
              "4" = "Asian and Pacific Island languages",
              "5" = "Other Language")

HISPEED_dict <- c("0" = "N/A (GQ/vacant/no paid access to the internet)",
                  "1" = "Yes",
                  "2" = "No")

JWTRNS_dict <- c("0" = "N/A (not a worker-not in the labor force, including persons under 16 years; unemployed; employed, with a job but not at work; Armed Forces, with a job but not at work)",
                 "10" = "Walked",
                 "11" = "Worked from home",
                 "12" = "Other method",
                 "07" = "Taxicab",
                 "02" = "Bus",
                 "05" = "Light rail, streetcar, or trolley",
                 "04" = "Long-distance train or commuter rail",
                 "09" = "Bicycle",
                 "01" = "Car, truck, or van",
                 "03" = "Subway or elevated rail",
                 "06" = "Ferryboat",
                 "08" = "Motorcycle")

SCH_dict <- c("0" = "N/A (less than 3 years old)",
              "1" = "No, has not attended in the last 3 months",
              "2" = "Yes, public school or public college",
              "3" = "Yes, private school or college or home school")

SCHL_dict <- c("16" = "Regular high school diploma",
               "01" = "No schooling completed",
               "04" = "Grade 1",
               "03" = "Kindergarten",
               "07" = "Grade 4",
               "23" = "Professional degree beyond a bachelor's degree",
               "19" = "1 or more years of college credit, no degree",
               "22" = "Master's degree",
               "10" = "Grade 7",
               "20" = "Associate's degree",
               "0" = "N/A (less than 3 years old)",
               "02" = "Nursery school, preschool",
               "21" = "Bachelor's degree",
               "08" = "Grade 5",
               "24" = "Doctorate degree",
               "06" = "Grade 3",
               "14" = "Grade 11",
               "17" = "GED or alternative credential",
               "12" = "Grade 9",
               "15" = "12th grade - no diploma",
               "13" = "Grade 10",
               "05" = "Grade 2",
               "11" = "Grade 8",
               "18" = "Some college, but less than 1 year",
               "09" = "Grade 6")

SEX_dict <- c("1" = "male",
              "2" = "female")

region_dict <- c("1" = "Northeast",
      "9" = "Puerto Rico",
      "3" = "South",
      "2" = "Midwest",
      "4" = "West")

division_dict <- c("7" = "West South Central (South Region)",
      "2" = "Middle Atlantic (Northeast region)",
      "4" = "West North Central (Midwest region)",
      "6" = "East South Central (South region)",
      "3" = "East North Central (Midwest region)",
      "9" = "Pacific (West region)",
      "0" = "Puerto Rico",
      "5" = "South Atlantic (South region)",
      "8" = "Mountain (West region)",
      "1" = "New England (Northeast region)")

state_dict <- c("01" = "Alabama/AL",
      "49" = "Utah/UT",
      "21" = "Kentucky/KY",
      "26" = "Michigan/MI",
      "29" = "Missouri/MO",
      "32" = "Nevada/NV",
      "34" = "New Jersey/NJ",
      "08" = "Colorado/CO",
      "51" = "Virginia/VA",
      "39" = "Ohio/OH",
      "02" = "Alaska/AK",
      "46" = "South Dakota/SD",
      "04" = "Arizona/AZ",
      "06" = "California/CA",
      "55" = "Wisconsin/WI",
      "15" = "Hawaii/HI",
      "22" = "Louisiana/LA",
      "30" = "Montana/MT",
      "47" = "Tennessee/TN",
      "48" = "Texas/TX",
      "09" = "Connecticut/CT",
      "50" = "Vermont/VT",
      "53" = "Washington/WA",
      "17" = "Illinois/IL",
      "20" = "Kansas/KS",
      "72" = "Puerto Rico/PR",
      "35" = "New Mexico/NM",
      "36" = "New York/NY",
      "10" = "Delaware/DE",
      "11" = "District of Columbia/DC",
      "12" = "Florida/FL",
      "56" = "Wyoming/WY",
      "16" = "Idaho/ID",
      "25" = "Massachusetts/MA",
      "27" = "Minnesota/MN",
      "42" = "Pennsylvania/PA",
      "45" = "South Carolina/SC",
      "13" = "Georgia/GA",
      "23" = "Maine/ME",
      "24" = "Maryland/MD",
      "28" = "Mississippi/MS",
      "37" = "North Carolina/NC",
      "41" = "Oregon/OR",
      "05" = "Arkansas/AR",
      "19" = "Iowa/IA",
      "31" = "Nebraska/NE",
      "33" = "New Hampshire/NH",
      "44" = "Rhode Island/RI",
      "54" = "West Virginia/WV",
      "18" = "Indiana/IN",
      "38" = "North Dakota/ND",
      "40" = "Oklahoma/OK")
```

```{r}
call_API <- function(year=2022, num_vars = c("PWGTP", "AGEP"), char_var = c("SEX"), geo_level = "state", geo_subset = "09") {
  if (!is.numeric(year) | year < 2010 | year > 2022) {
  
    stop("year input invalid!") 
    
  } else if (!is.element("PWGTP", num_vars)) {
  
    stop("numeric variables does not contain PWGTP") 
    
  } else if (length(num_vars) < 2) {
    
    stop("must enter more than one numeric variable")
    
  } else if ( !all(num_vars %in% c("PWGTP", "AGEP", "GASP", "GRPIP", "JWAP", 
                             "JWDP", "JWMNP"))) {
    stop("entered an invalid numeric variable")
    
  } else if (!all(char_var %in% c("FER", "HHL", "HISPEED", "JWTRNS", "SCH", 
                             "SCHL", "SEX"))) {
    
    stop("entered  an invaild character varaible") 
    
  } else {
    
    geo_paste <- ifelse(geo_level == "all", "",
                        paste0("&for=",geo_level,":",
                        geo_subset))
    
    my_url <- paste0("https://api.census.gov/data/",
                     year,
                     "/acs/acs1/pums?get=",
                     paste(char_var,collapse =","),
                     ",",
                     paste(num_vars,collapse =","),
                     geo_paste,
                     "&key=51fa8d7040e7bff1dae932352f6b998a4678a557")
    
  }

  # Use the helper function to query the API with the URL, then make a tibble
  API_data <- api_tibble(httr::GET(my_url))
 
  # Using dictionaries to convert the values in the character variables
  # Then converting those character type columns to factors
  for (var in c(char_var, geo_level)) {
    API_data <- API_data |> 
      # the !! := part allows you to use a "string" for a new variable name
      # get() takes a string and gets the corresponding dictionary or column
      mutate(!!var := as.factor(get(paste0(var, "_dict"))[get(var)]))
  }
  
  # Converts the remaining columns to numeric
  API_data <- API_data |>
    # Across all columns that are character type, convert them to numeric
    mutate(across(where(is.character), as.numeric))
  
  return(API_data)
}
```

```{r}
test_tib <- call_API(2022, 
                     c("PWGTP", "AGEP", "GASP", "GRPIP", "JWMNP"), 
                     c("SEX","FER","HHL", "HISPEED", "JWTRNS", "SCH", "SCHL"), 
                     "state", 
                     "09")
test_tib
```

```{r}
year <- 2022
num_var <- "PWGTP,AGEP,JWAP"
char_var <- "SEX,FER"
state <- "09"
my_url <- paste0("https://api.census.gov/data/",
                 year,
                 "/acs/acs1/pums?get=",
                 char_var,
                 ",",
                 num_var,
                 "&for=state:",
                 state,
                 "&key=51fa8d7040e7bff1dae932352f6b998a4678a557")
my_url

```

```{r}
# Somewhere we need to turn numerical variables into numeric or time values 
# Somwhere we need to turn categorical variables into factors 
# temporarily doing that here. 
census_data <- api_tibble(httr::GET(my_url))

if ("SEX" %in% names(census_data)) {
  census_data <- census_data |>
    mutate(SEX = ifelse(SEX == "1", "Male", 
                        ifelse(SEX == "2", "Female", "NA"))) |>
    mutate(SEX = factor(SEX))
}
 census_data |> 
   mutate(across(any_of(c("PWGTP", "AGEP", "GASP")), as.numeric))

census_data$SEX <- as.factor(census_data$SEX)
census_data$FER <- as.factor(census_data$FER)
census_data$PWGTP <- as.numeric(census_data$PWGTP)
census_data$AGEP <- as.numeric(census_data$AGEP)
census_data$GASP <- as.numeric(census_data$GASP)

census_data
```

## Multiple Year Function

Write a function that allows the user to specify multiple years of survey data (and all the other options above). Calls the single year function as many times as needed and then combines the data into one final tibble (with a year variable included).

## Summary Function

We can write our own custom summary function with the tibble that has a class of "census".

```{r}
# Write function that produces means and std devs for numeric variables
# and counts for categorical variables. 
summary.census <- function(data, 
                           num_var_vec = c("all"), 
                           cat_var_vec = c("all")) {
  summary_list <- list()
  # By default, summarize all numeric variables (other than PWGTP)
  # and all categorical variables in the tibble
  # User should be able to specify the variables they'd like to summarize
  if (num_var_vec[1] == "all") {
    # num_var_vec <- all is.numeric() columns in the tibble
  }
  if (cat_var_vec[1] == "all") {
    # cat_var_vec <- all is.character() columns in the tibble
  }
  
  for (var in num_var_vec) {
    if (var %in% names(data)) {
      # Calculate the sample mean for the numeric variable
      summary_list[paste0(var,"_mean")] <- 
        sum(data[,var] * data$PWGTP) / sum(data$PWGTP)
      
      # Calculate the sample standard deviation for the numeric variable
      sd_mean <- summary_list[[paste0(var,"_mean")]]
      summary_list[paste0(var, "_sd")] <- 
        sqrt(sum(data$PWGTP*(data[,var] - sd_mean)^2)/ (sum(data$PWGTP) - 1))
        
    }
  }
  
  # Counting the the categorical variables
  for (var in cat_var_vec) {
    summary_list[[paste0(var,"_count")]] <- data |> 
      group_by(data[,var]) |>
      summarise(count = sum(PWGTP))
  }
  
  # return the values as a named list
  return(summary_list)
}

summary(census_data, c("AGEP","GASP"), c("SEX","FER"))
```

## Plot Function

Code for creating a plot for a census class tibble with ggplot

Requires the user to specify one categorical variable and one numeric variable for plotting purposes.

```{r}
# Assumes that column names will be passed as strings. 
plot.census <- function(data, cat_var, num_var) {
  ggplot(data, 
         aes(x = get(cat_var), y = get(num_var), weight = PWGTP)) +
  geom_boxplot() +
    labs(title = paste(num_var, "Boxplots Grouped By", cat_var, sep=" "),
         x = cat_var, y = num_var)
}
```

```{r}
plot(census_data, "FER", "AGEP")
```
